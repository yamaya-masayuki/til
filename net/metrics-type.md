# メトリクスの種類

[モダンなインフラストラクチャの監視](https://lp.datadoghq.com/rs/875-UVY-685/images/eBookMonitoringModernInfrastructureJP.pdf)より。

監視データはメトリクスとイベントに大別される。

## メトリクス

ワークメトリクスとリソースメトリクス、その他のメトリクスの3種類。

### ワークメトリクス

システムのトップレベルのヘルスを示す。
これは、実質的な問題、多くの場合はユーザーが直面する問題を洗い出す上で非常に有用。

次のサブタイプに分類すると便利。

- **スループット**

  単位時間あたりにシステムが実行している作業量。
  スループットは通常、絶対数として記録される。

- **成功**メトリクス

  正常に実行した作業の割合。

- **エラー**メトリクス

  エラーになった結果数。通常、単位時間あたりのエラー発生率として示される。
  また、ある作業単位でエラーを生成したスループットにより正規化される。
  エラーメトリクスは、その潜在的な原因がいくつかある場合、成功メトリクスとは別に取得されることが多くあります。エラーメトリクスの中には他のメトリクスよりも重大な意味を持ち、即時の対策が必要となる場合がある。

- **パフォーマンス**メトリクス

  コンポーネントが処理をどれだけ効率的に実行しているかを定量化する。
  最も一般的なパフォーマンスメトリクスは、ある処理単位を完了するために必要な時間を示すレイテンシである。レイテンシは「要求の99%が0.1秒以内に返される」など、平均値またはパーセンタイルで表すことができる。

#### ワークメトリクスの例: Webサーバ

サブタイプ    |説明                                   |値
--------------|---------------------------------------|----
スループット  |1秒あたりの要求数                      |312
成功          |最後に測定してから2xxであった応答の割合|99.1
エラー        |最後に測定してから5xxであった応答の割合|0.1
パフォーマンス|応答時間の90パーセンタイル値(秒)       |0.4

#### ワークメトリクスの例: データストア

サブタイプ    |説明                                      |値
--------------|------------------------------------------|----
スループット  |1秒あたりのクエリ数                       |949
成功          |最後の測定から正常に実行されたクエリの割合|100
エラー        |最後の測定から例外を発生したクエリの割合  |0
エラー        |最後の測定から古いデータを戻したクエリの割合  |4.2
パフォーマンス|応答時間の90パーセンタイル値(秒)       |0.02

### リソースメトリクス

依存している下位リソースのメトリクス。
下位リソースとは、CPU、メモリ、ディスク、ネットワークインターフェイスなどの物理
コンポーネント、および、データベースや地理情報マイクロサービスなどの上位レベル
のコンポーネントを指す。

次の4つの主要な領域をカバーするメトリクスを収集すべき。

- **使用率**

  リソースがビジーである時間の割合。
  もしくは、使用されているリソースキャパシティの割合。

- **サチュレーション** (飽和)

  要求された作業のうち、リソースがまだ処理できていない量。
　サチュレーションは多くの場合、キューの長さによって測定される。

- **エラー**

  リソースが生成する作業では観測できない可能性がある内部エラー。

- **可用性**

  リソースが要求に応答した時間の割合。
  このメトリクスは、目的を持って可用性を定期的にチェックできるリソースについて
  のみ明確に定義されます。

#### リソースメトリクスの例

リソース        |利用率|サチュレーション|エラー|可用性
----------------|------|----------------|------|------
ディスクIO      |デバイスがビジーになった時間の割合|待ち行列の長さ|デバイスエラー件数|書き込み可能な時間の割合
メモリ          |使用されている総メモリキャパシティの割合|スワップの利用率|N/A<br>(通常は観測不能)|N/A
マイクロサービス|各要求が処理しているスレッドがビジーになっている時間の平均|待機状態の要求数|内部エラー数<br>例: 例外発生|サービスにアクセスできる時間の割合
データベース    |各接続がビジーになっている時間の平均|待機状態のクエリ数|内部エラー数<br>例: レプリケーションエラー|データベースにアクセスできる時間の割合

### その他のメトリクス

ワークでもリソースでもないメトリクス。
キャッシュヒット率やデータベースロック数など。

## イベント

個別かつ不定期に発生する事象。
システムの動作の変化を把握するための重要なコンテキストを提供します。

例:

- 変更: コードのリリース、ビルド、ビルド失敗
- アラート: プライマリの監視システム、または、統合型の3rdパーティツールから生成された通知
- スケーリングイベント: ホストまたはコンテナの追加または削除

文脈の中でのみ有意となる単一のメトリクスデータポイントとは異なり、イベントには
通常十分な情報が含まれており、イベントだけでその意味を解釈できる。

