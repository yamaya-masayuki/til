# シェーダーのボトルネックを減らす

[Reducing Shader Bottlenecks | Apple Developer Documentation](https://developer.apple.com/documentation/metal/optimizing_performance_with_the_gpu_counters_instrument/reducing_shader_bottlenecks)の勝手訳

リミッターカウンターを使用して、シェーダーが最も時間を費やす場所を特定し、問題を軽減するための措置を講じることができます。

## 概要

GPUは、演算処理、メモリアクセス、ラスタライズなど、さまざまな動作を並行して処理します。リミッターカウンターは、GPUのどのサブシステムがアクティブかを、そのサブシステムがアクティブだった時のプロセッササイクルの総数に対するパーセンテージで表示します。リミッター値が高いと、サブシステムが多くの作業を実行しているか、実行待ちの新しい作業の開始をブロックしていることがわかります。

占有率と同様に、スコアが高ければ自動的に問題があるというわけではありません。最終的な目標は、これらのリミッター値を増減させることではなく、より多くのGPUコマンドを実行し、より速く処理するための手がかりとして使用することです。たとえば、ALU (Arithmetic Logic Unit) リミッターカウンタの値が高い場合、ALUサブシステムの使用を減らすと、たとえカウンタ値に変化がなくても、パフォーマンスが向上することがあります。

次のセクションでは、特定のGPUサブシステムにかかる圧力を軽減するために、あなたが取ることができるアクションについて説明します。提案は一般的にこれらのパターンに分類されます:

- サブシステムが実行する操作の回数を減らす。
- サブシステム内で実行する処理の品質や精度を下げる。
- GPUのメモリキャッシュに与える影響が少ないパターンでメモリにアクセスする。
- 使用率の低い他のサブシステムに作業を移動する。

提案の中には、サブシステムがより少ない仕事を実行するために、品質や精度を下げるというトレードオフのものもあります。これらのトレードオフがあなたのアプリで受け入れられるかどうかを判断し、これらの変更がパフォーマンスを向上させるかどうかを発見するために実験を行う必要があります。

## ALUリミッターカウンター

TBD

## テクスチャーサンプルリミッターカウンター

このカウンタは、GPU がテクスチャサンプリング操作を実行するのに費やす時間を測定します。GPUは、シェーダがサンプル、収集、または読み込み操作を実行するとき、およびレンダーパスがそのカラーアタッチメントのいずれかに`MTLLoadActionLoad`アクションで構成されているときはいつでもテクスチャをサンプリングします。

> ロードアクションはレンダーパスが実行されるときに、前に書き込まれた情報をどうするかの指定です。
> `MTLLoadActionClear`を指定すると情報がクリアされ、その時のレンダーパスで描かれたものだけが表示されます。
> `MTLLoadActionLoad`を指定するとクリアされずに上書きすることができます。
> カラーレンダーターゲットに対しては`MTLLoadActionDontCare`がデフォルト。
> デプス、ステンシルターゲットのデフォルト値は`MTLLoadActionClear`

大きな寸法またはピクセルフォーマットのテクスチャは、より多くのメモリを使用し、GPUにロードされるデータもより多く必要です。テクスチャでより大きなミップマップにアクセスする場合、テクスチャの読み込み性能に大きな影響を与える可能性があります。

高い値が表示された場合は、以下をお試しください:

- より大きなテクスチャにミニフィケーションフィルタが適用される可能性がある場合、ミップマップを使用する。

- トリリニアフィルタリングではなくバイリニアフィルタリングを使用する。

- 異方性フィルタリングのサンプル数を少なくする。

- テクスチャから読み取る値が安価に計算できる場合は、シェーダで計算する。

- テクスチャのピクセルフォーマットやサイズを小さくする。

- 適用可能な場合は、シングルチャネルのテクスチャを読み取ったり サンプリングするのではなく、ギャザー操作を使用する。そうすることで、テクスチャハードウェアをより効率的に使用することができます。

## テクスチャ書き込みリミッターカウンター

このカウンタは、GPUがテクスチャへの書き込みやテクスチャの書き込みが完了するまでの待ち時間に費やした時間を測定します。テクスチャの書き込みは、レンダーパスがそのカラーアタッチメントのいずれかに`MTLStoreActionStore`アクションを実行したとき、およびシェーダが明示的にテクスチャに書き込む場所であればどこでも発生します。大きなテクスチャと大きなピクセルフォーマットのテクスチャは、テクスチャ書き込み性能に大きな影響を及ぼします。

高い値が表示される場合は、以下をお試しください:

- より小さなピクセルフォーマットを使用する。

- MSAAのサンプル数を減らす。

- 特にMSAAを使用する場合は、レンダリングする極小トライアングルの数を減らす。

- 空間的および時間的な局所性を高めてテクスチャにデータを書き込む。ハードウェアは、メモリ書き込みをより少ないトランザクションに合体させることができます。

## バッファ読み込みリミッターカウンター

TBD

## バッファ書き込みリミッターカウンター

TBD

## スレッドグループ/画像ブロック(ローカルメモリ)読み込みリミッターカウンター

TBD

## スレッドグループ/画像ブロック(ローカルメモリ)書き込みリミッターカウンター

TBD

## フラグメント入力補間リミッターカウンター

TBD

## GPU最終レベルキャッシュリミッターカウンター

TBD

