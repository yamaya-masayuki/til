# WWDC 2022 - Replace CAPTCHAs with Private Access Tokens

## CAPTCHAの問題点

- UX
- IPアドレス追跡
- アクセシビリティ

まず、iPhone、iPad、Macを持っていて、パスワード、Touch ID、Face IDでデバイスのロックを解除していること。また、ほとんどの場合、Apple IDでデバイスにサインインしています。そして、コード署名されたアプリを起動している。

この情報は、CAPTCHAに頼ることなく、またクライアントを追跡することでプライバシーを損なうことなく、サーバーが正当なクライアントを信頼し、不正を防止するのに役立ちます。プライベートアクセストークンは、iOS 16とmacOS Venturaの新機能で、サーバーがクライアントを自動的に信頼できるようにするものです。このトークンの仕組みを説明する前に、実際に使っているところをお見せします。きっと気に入るはずです。Financial Timesのサイトの記事を読んでみたい。このシナモンパンにとても期待しています。iOS 15を搭載した機種と、Private Access TokensをサポートしたiOS 16を搭載した機種の2つで、サイトを読み込んでみました。iOS 15の携帯電話で起動し、私はサインインをクリックし、私のアカウントとパスワードを記入してください. しかし、その後、私はCAPTCHAに見舞われる. 私はその記事を読むことができるようにする前に、文字を入力する必要があります。

Private Access Tokensに対応したiOS 16の携帯電話で全く同じことをすると、すぐにアクセスできます。これは多くの人と多くの時間を節約し、あなたの顧客は信頼されていることに感謝することになるでしょう。Private Access Tokensは、IETFのPrivacy Passワーキンググループで標準化されている技術を利用して、先ほどご覧いただいたようなCAPTCHAをサーバーに回避させることができます。Appleは、これを可能にするために、業界全体の企業と協力しています。

## Privacy passプロトコル

- [IETFによるPrivacy pass標準](https://datatracker.ietf.org/wg/privacypass/about/)
- [PrivateToken HTTP認証](https://www.ietf.org/archive/id/draft-ietf-privacypass-auth-scheme-01.html)
- [RSAブラインド署名](https://ja.wikipedia.org/wiki/ブラインド署名)

このプロトコルを使うと、サーバーは新しい HTTP 認証方法である PrivateToken を使ってトークンを要求することができます。これらのトークンは、RSAブラインド署名を使用して、クライアントが認証チェックをパスできたという事実を暗号的に署名します。これらの署名は「リンク不能」です。つまり、トークンを受け取ったサーバーは、そのトークンが有効であることを確認できるだけで、クライアントの身元を発見したり、長期間にわたってクライアントを認識したりすることはできません。プロトコルの仕組みは以下の通りです。

まず、iOSやmacOSのクライアントがHTTPでサーバーにアクセスすると、サーバーはPrivateToken認証スキームを使ってチャレンジを送り返す。これは、サーバーが信頼するトークン発行者を指定するものです。

クライアントはトークンを取得する必要がある場合、iCloudのアッテスター(`attester` ~ `attest`="証明書する")にコンタクトし、トークン・リクエストを送信します。このトークンリクエストは「ブラインド」されているため、サーバーチャレンジとリンクさせることはできません。アッテスターは、デバイスのSecure Enclaveに保存されている証明書を使用してデバイスの認証を行い、アカウントが良好な状態にあることを確認します。

このアテスターは、クライアントデバイスが通常のパターンに従っているか、あるいは侵害されているか、あるいはデバイス群の一部として使用されている可能性があるかを認識するために、レート制限を行うことも可能である。

クライアントが認証された場合、アッテスターは新しいトークンのリクエストを発行者に送ります。

トークン発行者はそのリクエストを受け取ったとき、クライアントについて何も知りません。しかし、iCloudのアテスターを信頼しているため、トークンに署名をします。

そして、署名されたトークンを受け取ったクライアントは、元のサーバーが検証できるように「アンブラインド」と呼ばれる処理でトークンを変形させます。

そして最後に、クライアントは署名済みトークンをサーバに提示します。サーバーはこのトークンが発行元によって署名されていることを確認できますが、このトークンを使ってクライアントを識別・認識することはできません。

では、この技術をサーバーで活用するにはどうすればよいのでしょうか。サーバーにプライベート・アクセストークンを採用するには、3つのステップがあります。

## 採用ステップ

1. トークン発行者を選択する
2. サーバーからPrivateToken HTTP認証のチャレンジを送信する
3. クライアントから送信されたトークンをサーバーで検証する

### トークン発行者の選択

トークン発行者は、サーバーが検証するトークンに署名することができる信頼できるプロバイダーです。これは、既存のCAPTCHAプロバイダ、ウェブホスティングサービス、またはCDNとも呼ばれるコンテンツデリバリーネットワークのいずれかになる可能性があります。iOS 16とmacOS Venturaのベータ版では、すでにテストを開始できる2つのトークン発行者があります。**Fastly**と**Cloudflare**は、Privacy Passの規格を開発してきたCDNで、すでに発行者サービスを公開しています。他のCAPTCHAプロバイダー、ウェブホスティングサービス、CDNも、Appleのデバイスで動作するトークン発行機を稼働させることができるようになる予定です。

発行者は今年後半にregister.apple.comからサインアップできるようになる予定です。

特定のトークン発行者を利用することで、クライアントがアクセスしているウェブサイトを特定するようなことは避けなければなりません。そのため、トークン発行者は、少なくとも数百台のサーバーと連携している大規模なサービスである必要があります。

クライアントがあなたのサーバにアクセスしたとき、PrivateToken スキームで HTTP 認証チャレンジを送信することでトークンを要求することができます。これを行うには、2つのオプションがあります。既存の CAPTCHA や不正防止プロバイダと連携して、彼らのスクリプトにチャレンジを組み込み、自動的に処理させるか、あるいは、あなたのサーバから直接これらのチャレンジを送信することを選択することができます。

### 認証チャンレジの送信

- PrivateToken HTTP 認証スキーム
    - CAPTCHAプロバイダによりサポートされる
    - サーバーによって直接送信される
- ファーストパーティドメインが必要

クライアントがあなたのサーバにアクセスしたとき、PrivateToken スキームで HTTP 認証チャレンジを送信することでトークンを要求することができます。これを行うには、2つのオプションがあります。既存の CAPTCHA や不正防止プロバイダと連携して、彼らのスクリプトにチャレンジを組み込み、自動的に処理させるか、あるいは、あなたのサーバから直接これらのチャレンジを送信することを選択することができます。

ウェブサイトの一部としてこれを行う場合、チャレンジはファーストパーティドメイン（メインURLのサブドメイン）から行う必要があり、サイトに埋め込まれた別のサードパーティドメインは使用しないでください。

クライアントがトークンを返すとき、発行者の公開鍵を使ってその有効性をチェックする必要があります。また、クライアントがトークンを何度も提示しようとするリプレイ攻撃を防ぐためのチェックも必要でしょう。トークンは一度だけ使用することを想定しています。リプレイ攻撃を防ぐには、以前に送信されたトークンを記憶しておくか、チャレンジで送信された一意の値にトークンが署名することを義務づければよいでしょう。

## 互換性

- レガシークライアントのサポート
- ページロードのブロックを無効化する

あなたのサイトは、この認証チャレンジに応答しないレガシークライアントとまだ動作する必要があります。そのため、この認証はメインのページロードをブロックするのではなく、クライアントを信頼するためのオプションとして扱われることが重要です。SafariとWebKitでアクセスするウェブサーバーは自動的に動作しますが、アプリ内で直接Private Access Tokensを使用することもできます。

## 必要条件

- iOS 16 または macOS Ventura
- Sign in with an Apple ID
- WebKitまたはNSURLSession
- appが最前面である

Private Access Tokensを利用するには、Apple IDでサインインしているデバイスでiOS 16またはmacOS Venturaを利用する必要があります。このApple IDは認証にのみ使用され、トークンを受け取るサーバと共有されることはありません。アプリ内で、WebKit または URLSession を使用して HTTP を使用してサーバーに接続すると、トークンを利用できます。そうすると、アプリがフォアグラウンドにあるときにチャレンジを受信すると、システムが自動的に認証としてトークンを送信します。

## URLSessionサポート

- PrivateTokenは自動的に処理される
- トークンに関する失敗は401として応答される

URLSession を使用している場合、Private Access Tokens を動作させるために明示的に何かをする必要はありません。URLSessionはPrivateToken HTTP認証スキームを使用したチャレンジに自動的に応答します。ただし、アプリがフォアグラウンドにない場合や、デバイスに Apple ID でサインインしていない場合など、トークンの取得にエラーが発生した場合は、トークンのチャレンジを含む 401 HTTP 応答をアプリが受け取ります。これにより、アプリはトークン・チャレンジを受信したことを認識し、ユースケースに応じてエラーを正しく処理することができます。

## まとめ

Private Access Tokenが利用可能な場合は、CAPTCHAを回避でき、アプリやウェブサイトをすべての人にとってより良い体験にすることができます。トークンのチャレンジを送信し、トークンを検証するサーバーを有効にしてください。そして、アプリではURLSessionやWebKitを使ってPrivate Access Tokensを自動的にサポートするようにしましょう。あなたが作るCAPTCHAフリーの体験が楽しみです。

## その他

この発表に合わせてfastlyから[Private Access Tokens: stepping into the privacy-respecting, CAPTCHA-less future we were promised | Fastly](https://www.fastly.com/jp/blog/private-access-tokens-stepping-into-the-privacy-respecting-captcha-less)と言う記事が公開されている。
